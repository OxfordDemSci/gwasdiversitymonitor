{% extends "base.html" %}

{% block content %}

    <div class="dashboard row">

        <div class="loader">Loader</div>

        <div class="tile col-xs-12 col-sm-6 col-lg-3">
            <div class="box summary">
                {% include 'tiles/summary.html' %}
            </div>
        </div>

        <div class="tile col-xs-12 col-lg-6">
            <div class="box only-stage" id="bubbleGraph">
                {% include 'tiles/bubble-graph.html' %}
            </div>
        </div>

        <div class="tile col-xs-12 col-sm-6 col-lg-3">
            <div class="box metric-stage" id="timeSeries">
                {% include 'tiles/time-series.html' %}
            </div>
        </div>

        <div class="tile col-xs-12 col-sm-6 col-lg-3">
            <div class="box metric-stage heat-map" id="heatMap">
                {% include 'tiles/heat-map.html' %}
            </div>
        </div>

        <div class="tile col-xs-12 col-lg-6">
            <div class="box only-metric world-map" id="worldMap">
                {% include 'tiles/world-map.html' %}
            </div>
        </div>

        <div class="tile col-xs-12 col-sm-6 col-lg-3">
            {% with graph_id='doughnutGraph' %}
            <div class="box metric-stage doughnut-graph" id={{graph_id}}>
                {% include 'tiles/doughnut-graph.html' %}
            </div>
            {% endwith %}
        </div>

    </div>

    {% include 'components/logo-download.html' %}

    <div id="downloadShell" style="display: none;"></div>
    <canvas id="downloadCanvas" style="display: none;"></canvas>

    <script src="{{ url_for('static', filename='js/graphs/time-series.js') }}"></script>
    <script src="{{ url_for('static', filename='js/graphs/world-map.js') }}"></script>
    <script src="{{ url_for('static', filename='js/graphs/bubble-graph.js') }}"></script>
    <script src="{{ url_for('static', filename='js/graphs/heat-map.js') }}"></script>
    <script src="{{ url_for('static', filename='js/graphs/doughnut-graph.js') }}"></script>
    <script type="text/javascript">
		let timeseriesData;
		let heatData;
		let ancestriesData;
		let mapData;
		let doughnutData;
		let bubbleData;

        $(document).ready(function() {
			setDescription();

            initFundersSelect();

			d3.json("{{ url_for('getplotjson', filename='tsPlot.json') }}", (error, data) => {
				timeseriesData = data;
				drawTimeSeries(timeseriesData, '#timeSeries');
			});
			d3.json("{{ url_for('getplotjson', filename='heatMap.json') }}", (error, data) => {
				heatData = data;
				d3.json("{{ url_for('getplotjson', filename='ancestriesOrdered.json') }}", (error, adata) => {
					ancestriesData = adata;
					drawHeatMap(heatData, false, false, ancestriesData);
				})
			});
			d3.json("{{ url_for('getplotjson', filename='chloroMap.json') }}", (error, data) => {
				mapData = data;
				drawWorldMapChart(mapData);
                console.log('mapData', mapData);
			});
			d3.json("{{ url_for('getplotjson', filename='doughnutGraph.json') }}", (error, data) => {
				doughnutData = data;
				// drawDoughnutGraph("#doughnutGraph", doughnutData, false, false);
			});

			// d3.json("{{ url_for('getplotjson', filename='bubbleGraph.json') }}", (error, data) => {
			// 	bubbleData = data;
			// 	drawBubbleGraph("#bubbleGraph", bubbleData);
			// });
        });

        function highlight(box) {
            box.addClass('highlight');
            setTimeout(function() {
                box.removeClass('highlight');
            }, 1500)
        }

        function redrawGraph(el) {
            let metricFilter = document.getElementById('metric-filter');
            let stageFilter = document.getElementById('stage-filter');

            // true = by-studies
            // false = by-participants
            isMetricByStudies = (metricFilter.value === 'by-studies') ? true : false;
            // true = 'replication'
            // false = 'discovery'
            isStageReplication = (stageFilter.value === 'replication') ? true : false;

            // Redraw with Studies
            drawWorldMapChart(mapData, isMetricByStudies);
            drawTimeSeries(timeseriesData, '#timeSeries', isMetricByStudies, isStageReplication);
            drawHeatMap(heatData, isMetricByStudies, isStageReplication, ancestriesData);
            drawDoughnutGraph("#doughnutGraph", doughnutData, isMetricByStudies, isStageReplication);

            // Change titles
            filtersTitle(isMetricByStudies, isStageReplication);
            setDescription();

            // Highlight boxes
            var both = $('.metric-stage');
            if($(el).attr('id') === 'cb1') {
                var box = $('.only-metric');
            } else {
                var box = $('.only-stage');
                drawBubbleGraph("#bubbleGraph", bubbleData, isStageReplication);
            }
            highlight(both);
            highlight(box);
        }

        function filtersTitle(metric, stage) {
            let metricTitle = $('.metric-title');
            let stageTitle = $('.stage-title');

            if(metric) {
                metricTitle.html('Studies');
                if(stage) {
                    stageTitle.html('Replication');
                } else {
                    stageTitle.html('Discovery');
                }
            } else {
                metricTitle.html('Participants');
                if(stage) {
                    stageTitle.html('Replication');
                } else {
                    stageTitle.html('Discovery');
                }
            }
        }

        function numberFormatter(val) {
            if(val >= 1000000) {
                val = val / 1000000;
                val = Math.round( val * 10 ) / 10;
                val = val+"M";
            } else if(val >= 1000) {
                val = val / 1000;
                val = Math.round( val * 10 ) / 10;
                val = val+"k";
            } else {
                val = Math.round(val);
            }

            return val;
        }

        function initFundersSelect() {
            let mydata;
            fetch('api/funders')
            .then(response => response.json())
            .then(response_json => {
                mydata = response_json.data;
                // Select2-to-tree init
                $("#funders-select").select2ToTree({treeData: {dataArr:mydata}, placeholder: 'Select funders'});
            })


            // Select2-to-tree Open event
            $('#funders-select').on('select2:open', () => {
                $('.select2-dropdown').addClass('funders-dropdown');
            });

            // Select2-to-tree Change event
            $('#funders-select').on('select2:select', (e) => {
                // Get selected values and call backend endpoint
                let selectedFunderOptions = $('#funders-select').select2('data').map(node => node.text);

                // Map Data filter by funders
                filterMapDataByFunders(selectedFunderOptions);
            });

            $('#funders-select').on('select2:unselect', () => {
                // Get selected values and call backend endpoint
                let selectedFunderOptions = $('#funders-select').select2('data').map(node => node.text);

                // Map Data filter by funders
                if (selectedFunderOptions.length === 0) {
                    drawWorldMapChart(mapData);
                } else {
                    filterMapDataByFunders(selectedFunderOptions);
                }

                // TODO Heatmap filter by funders

                // TODO Timeseries filter by funders

                // TODO Doughnut Graph filter by funders

                // TODO Bubble Graph filter by funders

                // TODO Summary filter by funders
            });
        }

        function filterMapDataByFunders(selectedFunderOptions) {
            let mapDataByFunders;
            let mapDataArray = Object.entries(mapData);
            let structuredFilteredData = {};

            mapDataArray.forEach(year => {
                let filteredData = Object.values(year[1]).filter(node => {
                    return selectedFunderOptions.find(funder => funder === node.funder);
                });

                structuredFilteredData[year[0]] = filteredData;
            });

            drawWorldMapChart(structuredFilteredData);
        }
    </script>
{% endblock %}
